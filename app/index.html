---
---
<div class="page-header">
  <h1>Dashboard</h1>
  <p :text="'Overview for ' + currentMonth"></p>
</div>

<!-- Stats cards -->
<div class="card-grid">
  <div class="card">
    <div class="stat-label">Donations this month</div>
    <div class="stat-value stat-ok" :text="'$' + stats.donations.toLocaleString()"></div>
  </div>
  <div class="card">
    <div class="stat-label">Expenses this month</div>
    <div class="stat-value stat-err" :text="'$' + stats.expenses.toLocaleString()"></div>
  </div>
  <div class="card">
    <div class="stat-label">Net</div>
    <div class="stat-value" :class="stats.net >= 0 ? 'stat-ok' : 'stat-err'"
      :text="(stats.net >= 0 ? '+$' : '-$') + Math.abs(stats.net).toLocaleString()"></div>
  </div>
  <div class="card">
    <div class="stat-label">Active donors</div>
    <div class="stat-value" :text="stats.donors"></div>
  </div>
</div>

<!-- Recent activity -->
<div class="card">
  <h3 style="margin-bottom: var(--s-md)">Recent Activity</h3>
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Description</th>
          <th>Category</th>
          <th style="text-align:right">Amount</th>
        </tr>
      </thead>
      <tbody>
        <tr :each="item in recent">
          <td :text="item.date"></td>
          <td :text="item.description"></td>
          <td :text="item.category"></td>
          <td style="text-align:right" :class="item.type === 'donation' ? 'stat-ok' : 'stat-err'"
            :text="(item.type === 'donation' ? '+' : '-') + '$' + item.amount.toLocaleString()"></td>
        </tr>
        <tr :if="!recent.length">
          <td colspan="4" class="dim" style="text-align:center; padding: var(--s-lg)">
            No recent activity
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<script type="module">
  import sprae from '../lib/sprae.js'
  import { auth } from '../lib/auth.js'
  import { api } from '../lib/api.js'

  auth.capture()
  // if (!auth.guard()) throw 'redirect'

  const page = location.pathname.split('/').pop() || 'index.html'
  const months = ['January','February','March','April','May','June',
    'July','August','September','October','November','December']
  const now = new Date()

  const s = sprae(document.getElementById('app'), {
    user: auth.user,
    active: (href) => href === page,
    logout: () => auth.logout(),

    currentMonth: months[now.getMonth()] + ' ' + now.getFullYear(),
    stats: { donations: 0, expenses: 0, net: 0, donors: 0 },
    recent: [],
  })

  api.get('/dashboard').then(data => {
    if (data.stats) Object.assign(s.stats, data.stats)
    if (data.recent) s.recent = data.recent
  }).catch(() => {})
</script>
