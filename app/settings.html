---
---
<div class="page-header">
  <h1>Settings</h1>
  <p>System configuration and admin management.</p>
</div>

<div :if="!can('users:view')" class="card" style="text-align:center; padding:var(--s-xl)">
  <p class="dim">You don't have permission to manage users.</p>
</div>

<!-- User detail modal -->
<div class="modal-overlay" :if="showUser && can('users:view')" :onclick="e => { if (e.target === e.currentTarget) closeUser() }">
  <div class="modal">
    <div class="modal-header">
      <h2 :text="detail.email || ''"></h2>
      <button class="modal-close" :onclick="closeUser()">&times;</button>
    </div>
    <div class="modal-body">
      <div style="display:flex; flex-direction:column; gap:var(--s-md)">
        <div style="display:flex; gap:var(--s-lg); flex-wrap:wrap">
          <div>
            <div class="stat-label">Name</div>
            <div :text="userName(detail)"></div>
          </div>
          <div>
            <div class="stat-label">Role</div>
            <span class="badge" :text="roleName(detail)"></span>
          </div>
          <div>
            <div class="stat-label">Created</div>
            <div :text="detail.created_at?.slice(0, 10) || '—'"></div>
          </div>
          <div>
            <div class="stat-label">Last Login</div>
            <div :text="detail.last_login?.slice(0, 10) || 'Never'"></div>
          </div>
        </div>

        <div style="border-top:1px solid var(--c-border); padding-top:var(--s-md)">
          <div class="stat-label" style="margin-bottom:var(--s-sm)">Trusted Device</div>
          <div :if="detail.device">
            <div style="display:flex; align-items:center; justify-content:space-between; gap:var(--s-md)">
              <div>
                <code style="font-size:var(--f-sm)" :text="detail.device.device_id.slice(0, 8) + '…'"></code>
                <span class="dim" style="font-size:var(--f-sm); margin-left:var(--s-sm)" :text="'since ' + detail.device.created_at.slice(0, 10)"></span>
              </div>
              <button class="btn btn-outline btn-sm" style="color:var(--c-err); border-color:var(--c-err)" :onclick="revoke(detail)" :class="{dim: revoking}">Revoke</button>
            </div>
          </div>
          <div :if="!detail.device" class="dim" style="font-size:var(--f-sm)">No trusted device</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Admins -->
<div class="card" :if="can('users:view')">
  <div class="card-header">
    <h3>Administrators</h3>
    <button :if="can('users:create')" class="btn btn-primary btn-sm" :onclick="showAdd = true">+ Add Admin</button>
  </div>

  <div :if="showAdd" class="add-admin-form">
    <form :onsubmit.prevent="addAdmin">
      <div style="display:flex; gap:var(--s-sm); align-items:end; flex-wrap:wrap">
        <div class="field" style="flex:1; min-width:12rem; margin:0">
          <label for="admin-email">Email</label>
          <input id="admin-email" type="email" :value="newAdmin.email" placeholder="name@example.com" required>
        </div>
        <div class="field" style="flex:1; min-width:10rem; margin:0">
          <label for="admin-pw">Password (optional)</label>
          <input id="admin-pw" type="text" :value="newAdmin.password" placeholder="Leave blank for OTP-only" autocomplete="off">
        </div>
        <div class="field" style="min-width:8rem; margin:0">
          <label for="admin-role">Role</label>
          <select id="admin-role" :value="newAdmin.role_id">
            <option value="1">Admin</option>
            <option value="2">Treasurer</option>
            <option value="3">Viewer</option>
          </select>
        </div>
        <div style="display:flex; gap:var(--s-xs)">
          <button type="submit" class="btn btn-primary btn-sm" :class="{dim: saving}">Save</button>
          <button type="button" class="btn btn-outline btn-sm" :onclick="showAdd = false">Cancel</button>
        </div>
      </div>
      <div class="login-error" :if="addErr" :text="addErr" style="margin-top:var(--s-sm)"></div>
    </form>
  </div>

  <div :if="loadErr" class="login-error" :text="loadErr" style="margin:var(--s-md)"></div>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Email</th>
          <th>Role</th>
          <th>Created</th>
        </tr>
      </thead>
      <tbody>
        <tr :each="u in admins" style="cursor:pointer" :onclick="openUser(u)">
          <td :text="userName(u)"></td>
          <td :text="u.email"></td>
          <td><span class="badge" :text="roleName(u)"></span></td>
          <td class="dim" :text="u.created_at?.slice(0, 10) || '—'"></td>
        </tr>
        <tr :if="!admins.length && !loadErr">
          <td colspan="4" class="dim" style="text-align:center; padding:var(--s-lg)">Loading…</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<script type="module">
  import { init, auth } from '../lib/app.js'
  import { api } from '../lib/api.js'

  const s = init({
    admins: [],
    showAdd: false,
    showUser: false,
    detail: {},
    saving: false,
    revoking: false,
    loadErr: null,
    addErr: null,
    newAdmin: { email: '', password: '', role_id: '1' },

    userName(u) {
      if (!u.meta) return u.email?.split('@')[0] || '—'
      const m = typeof u.meta === 'string' ? JSON.parse(u.meta) : u.meta
      return [m.first_name, m.last_name].filter(Boolean).join(' ') || u.email?.split('@')[0] || '—'
    },

    roleName(u) {
      if (!u.role?.role) return '—'
      const r = typeof u.role.role === 'string' ? JSON.parse(u.role.role) : u.role.role
      return r.name || '—'
    },

    async openUser(u) {
      try {
        s.detail = await api.getUser(u.id)
        s.showUser = true
      } catch (e) {
        s.loadErr = e.message
      }
    },

    closeUser() {
      s.showUser = false
      s.detail = {}
    },

    async revoke(u) {
      s.revoking = true
      try {
        await api.revokeDevice(u.id)
        s.detail = { ...s.detail, device: null }
      } catch (e) {
        s.loadErr = e.message
      } finally {
        s.revoking = false
      }
    },

    async addAdmin() {
      s.addErr = null
      s.saving = true
      try {
        const user = await api.createUser({
          email: s.newAdmin.email,
          password: s.newAdmin.password || undefined,
          role_id: parseInt(s.newAdmin.role_id),
        })
        s.admins = [...s.admins, user]
        s.newAdmin = { email: '', password: '', role_id: '1' }
        s.showAdd = false
      } catch (e) {
        s.addErr = e.message || 'Failed to create user'
      } finally {
        s.saving = false
      }
    },
  })

  if (auth.can('users:view')) api.getUsers().then(users => { s.admins = users }).catch(e => { s.loadErr = e.message })
</script>
