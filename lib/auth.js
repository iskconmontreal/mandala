// auth.js â€” token management + route guard

const TOKEN_KEY = 'mandala_token'
const USER_KEY = 'mandala_user'
const DEVICE_KEY = 'mandala_device'

// Resolve path relative to site root (works from any subdirectory)
const base = new URL('..', import.meta.url).pathname

export const auth = {
  get token() { return localStorage.getItem(TOKEN_KEY) },
  get user() { try { return JSON.parse(localStorage.getItem(USER_KEY)) } catch { return null } },
  get deviceId() {
    let id = localStorage.getItem(DEVICE_KEY)
    if (!id) { id = crypto.randomUUID(); localStorage.setItem(DEVICE_KEY, id) }
    return id
  },

  save(token, user) {
    localStorage.setItem(TOKEN_KEY, token)
    if (user) localStorage.setItem(USER_KEY, JSON.stringify(user))
  },

  clear() {
    localStorage.removeItem(TOKEN_KEY)
    localStorage.removeItem(USER_KEY)
  },

  get permissions() {
    try { return JSON.parse(atob(this.token.split('.')[1])).permissions || [] }
    catch { return [] }
  },

  can(perm) { return this.permissions.includes(perm) },

  get active() { return !!this.token },

  // Redirect to login if not authenticated
  guard() {
    if (!this.active) {
      window.location.href = base + 'login.html'
      return false
    }
    return true
  },

  // Capture token from URL fragment (after OAuth redirect)
  capture() {
    const hash = window.location.hash
    if (!hash) return false
    const params = new URLSearchParams(hash.slice(1))
    const token = params.get('token')
    const user = params.get('user')
    if (token) {
      this.save(token, user ? JSON.parse(decodeURIComponent(user)) : null)
      history.replaceState(null, '', window.location.pathname)
      return true
    }
    return false
  },

  logout() {
    this.clear()
    window.location.href = base + 'login.html'
  }
}
